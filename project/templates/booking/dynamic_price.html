{% extends "core/base.html" %}
{% load static %}
{% block content %}

<head>

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles to match the reference and style Django form fields */
        body {
            background-color: #f0f2f5;
        }
        /* Style the input fields generated by Django forms */
        input[type="text"], input[type="number"], input[type="time"], select {
            border: none;
            outline: none;
            width: 100%;
            background-color: transparent;
            font-size: 1rem;
            padding: 0;
            margin: 0;
        }
        /* Remove number input spinners */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        /* Styling for the tab-like radio buttons */
        .trip-tabs input[type="radio"] {
            display: none;
        }
        .trip-tabs input[type="radio"]:checked + label {
            border-color: #3b82f6; /* border-blue-500 */
            color: #2563eb; /* text-blue-600 */
        }

        /* Styling for the transport type radio pills */
        .transport-pills input[type="radio"] {
            display: none; /* Hide the actual radio button */
        }
        .transport-pills input[type="radio"]:checked + div {
            border-color: #3b82f6;
            background-color: #eff6ff;
            color: #2563eb;
        }
        .transport-pills input[type="radio"]:checked + div svg {
            color: #2563eb;
        }
    </style>
</head>


    <div id="budget" class="w-full max-w-5xl mx-auto">
        <!-- Main Title -->
        <div class="text-center mb-6">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-800">Find your next journey</h1>
            <p class="text-gray-500 mt-2">Book buses, minibuses, and more with ease.</p>
        </div>

        <!-- Search Component Container -->
        <div class="bg-white rounded-xl shadow-lg p-4 md:p-6">
            <!-- FORM: The action, method, and data-quote-url are preserved -->
            <form id="booking-form" method="POST" action="" data-quote-url="{% url 'booking_quote' %}">
                {% csrf_token %}

                <!-- Tabs for Trip Type -->
                <div class="flex border-b mb-4 trip-tabs">
                    {% for radio in form.trip_type %}
                    <div class="flex-1">
                        {{ radio.tag }}
                        <label for="{{ radio.id_for_label }}" class="flex items-center justify-center gap-2 px-4 py-3 border-b-2 font-semibold transition-colors focus:outline-none cursor-pointer border-transparent text-gray-500 hover:text-gray-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" /></svg>
                            <span>{{ radio.choice_label }}</span>
                        </label>
                    </div>
                    {% endfor %}
                </div>

                <!-- Main Input Fields Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Pickup Location -->
                    <div class="flex items-center gap-3 p-3 border rounded-lg hover:border-blue-500 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        <div class="w-full">
                            <label class="text-xs text-gray-500">Pickup Location</label>
                            {{ form.pickup_location_1 }}
                        </div>
                    </div>

                    <!-- Dropoff Location -->
                    <div class="flex items-center gap-3 p-3 border rounded-lg hover:border-blue-500 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        <div class="w-full">
                            <label class="text-xs text-gray-500">Dropoff Location</label>
                            {{ form.dropoff_location_1 }}
                        </div>
                    </div>

                    <!-- Pickup Time -->
                    <div class="flex items-center gap-3 p-3 border rounded-lg hover:border-blue-500 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        <div class="w-full">
                            <label class="text-xs text-gray-500">Pickup Time</label>
                            {{ form.pickup_time }}
                        </div>
                    </div>

                    <!-- Return Pickup Location (for Round Trip) -->
                    <div id="leg2_pickup" style="display:none;" class="flex items-center gap-3 p-3 border rounded-lg hover:border-blue-500 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        <div class="w-full">
                            <label class="text-xs text-gray-500">Return Pickup</label>
                            {{ form.pickup_location_2 }}
                        </div>
                    </div>

                    <!-- Return Dropoff Location (for Round Trip) -->
                     <div id="leg2_dropoff" style="display:none;" class="flex items-center gap-3 p-3 border rounded-lg hover:border-blue-500 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        <div class="w-full">
                            <label class="text-xs text-gray-500">Return Dropoff</label>
                            {{ form.dropoff_location_2 }}
                        </div>
                    </div>

                    <!-- Return Time (for Round Trip) -->
                    <div id="return_time_container" style="display:none;" class="flex items-center gap-3 p-3 border rounded-lg hover:border-blue-500 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        <div class="w-full">
                            <label class="text-xs text-gray-500">Return Time</label>
                            {{ form.return_time }}
                        </div>
                    </div>
                </div>

                <!--
                  *** UPDATED BOTTOM SECTION ***
                  - This outer container now holds all bottom elements. It stacks on small screens and becomes a row on large screens.
                -->
                <div class="flex flex-col lg:flex-row items-center lg:items-end justify-between mt-6 gap-6">

                    <!-- Left-side container for Transport and Passengers -->
                    <div class="flex flex-col sm:flex-row items-start sm:items-end gap-4 w-full lg:w-auto">
                        <!-- Transport Type Radio Pills -->
                        <div class="w-full sm:w-auto">
<!--                            <label class="text-sm font-semibold text-gray-700 mb-2 block">Transport Type</label>-->
                            <div class="grid grid-cols-2 sm:grid-cols-2 gap-2 transport-pills">
                                {% for radio in form.transport_type %}
                                <label for="{{ radio.id_for_label }}" class="cursor-pointer">
                                    {{ radio.tag }}
                                    <div class="p-3 border rounded-lg text-center transition-colors hover:border-blue-500">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto mb-1 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                        <span class="font-semibold text-xs">{{ radio.choice_label }}</span>
                                    </div>
                                </label>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Passengers -->
                        <div class="flex items-center gap-3 p-3 border rounded-lg hover:border-blue-500 transition-colors w-full sm:w-auto">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                            <div class="w-full">
                                <label class="text-xs text-gray-500">Passengers</label>
                                {{ form.passengers }}
                            </div>
                        </div>
                    </div>

                    <!-- Right-side container for Price and Search Button -->
                    <div class="flex items-center gap-4 w-full lg:w-auto">
                        <!-- Price Estimate Badge -->
                        <div class="text-right flex-grow lg:flex-grow-0">
                             <div id="quoteHint" class="text-xs text-gray-400 mb-1">Enter details for a price</div>
                             <div class="text-2xl font-bold text-gray-800" id="priceDisplay">€0.00</div>
                        </div>
                        <!-- Search Button -->
                        <button type="submit" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                            SEARCH
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

<!-- ===================== JS: Round Trip UI & Live Price ===================== -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById("booking-form");
    const leg2_pickup = document.getElementById("leg2_pickup");
    const leg2_dropoff = document.getElementById("leg2_dropoff");
    const returnTimeContainer = document.getElementById("return_time_container");
    const priceDisplay = document.getElementById('priceDisplay');
    const quoteUrl = form.dataset.quoteUrl;
    const hint = document.getElementById('quoteHint');

    const get = sel => (form.querySelector(sel) || {}).value || "";

    const currentTrip = () => (form.querySelector('input[name="trip_type"]:checked') || {}).value || "";

    const setReq = (name, on) => {
        const el = form.querySelector(`[name="${name}"]`);
        if (!el) return;
        on ? el.setAttribute('required', 'required') : el.removeAttribute('required');
    };

    function toggleRT() {
        const isRT = currentTrip() === "Round Trip";
        const displayStyle = isRT ? "flex" : "none";

        leg2_pickup.style.display = displayStyle;
        leg2_dropoff.style.display = displayStyle;
        returnTimeContainer.style.display = displayStyle;

        setReq("pickup_location_2", isRT);
        setReq("dropoff_location_2", isRT);
        setReq("return_time", isRT);

        const p1 = get('[name="pickup_location_1"]');
        const d1 = get('[name="dropoff_location_1"]');
        const p2 = form.querySelector('[name="pickup_location_2"]');
        const d2 = form.querySelector('[name="dropoff_location_2"]');
        if (isRT && p1 && d1 && p2 && d2 && !p2.value && !d2.value) {
            p2.value = d1;
            d2.value = p1;
            p2.dispatchEvent(new Event("change", { bubbles: true }));
            d2.dispatchEvent(new Event("change", { bubbles: true }));
        }
    }

    function ensureDefaults() {
        if (!form.querySelector('input[name="trip_type"]:checked')) {
            form.querySelector('input[name="trip_type"]')?.click();
        }
        if (!form.querySelector('input[name="transport_type"]:checked')) {
            form.querySelector('input[name="transport_type"]')?.click();
        }
    }

    function buildQuery() {
        const p = new URLSearchParams();
        const put = (k, v) => { if (v) p.set(k, v); };
        put("trip_type", currentTrip());
        // For radio buttons, we need to find the checked one
        const transportType = form.querySelector('input[name="transport_type"]:checked');
        if (transportType) {
            put("transport_type", transportType.value);
        }

        ["pickup_location_1", "dropoff_location_1", "pickup_location_2", "dropoff_location_2", "pickup_time", "return_time", "passengers"].forEach(n => {
            const el = form.querySelector(`[name="${n}"]`);
            if (el) put(n, el.value);
        });
        return p.toString();
    }

    function showPrice(val) { if (priceDisplay) priceDisplay.textContent = val; }
    function showMessage(msg) { if (hint) { hint.textContent = msg; hint.style.display = ''; } }
    function clearMessage() { if (hint) { hint.style.display = 'none'; } }

    let timeout;
    const debounce = (fn, ms = 250) => (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn(...args), ms);
    };

    async function fetchQuote() {
        ensureDefaults();
        const p1 = form.querySelector('[name="pickup_location_1"]')?.value;
        const d1 = form.querySelector('[name="dropoff_location_1"]')?.value;
        if (!p1 || !d1) {
            showPrice("€0.00");
            showMessage("Select pickup & drop-off for a price.");
            return;
        }
        try {
            const res = await fetch(`${quoteUrl}?${buildQuery()}`);
            const data = await res.json();
            if (data && data.price != null) {
                clearMessage();
                showPrice(`€${Number(data.price).toFixed(2)}`);
            } else {
                showPrice("€0.00");
                showMessage("No price found for this route.");
            }
        } catch (_) {
            showPrice("€0.00");
            showMessage("Could not fetch an estimate.");
        }
    }

    const debouncedFetchQuote = debounce(fetchQuote);

    form.addEventListener("change", (e) => {
        if (e.target.name === "trip_type") {
            toggleRT();
        }
        debouncedFetchQuote();
    });
    form.addEventListener("keyup", debouncedFetchQuote);

    // Initial setup
    ensureDefaults();
    toggleRT();
});
</script>


{% endblock %}
