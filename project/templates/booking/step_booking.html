{% extends "core/base.html" %}
{% load static %}
{% block content %}
<!--
  NOTE: The <head> section has been removed from this block.
  CSS and global scripts like Tailwind should be included in your main `core/base.html` file's <head> tag.
-->
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Custom styles for a polished look */

        /* Style the input fields generated by Django forms */
        .form-card input, .form-card select, .form-card textarea {
            border: 1px solid #e2e8f0; outline: none; width: 100%; background-color: #f8fafc;
            font-size: 1rem; padding: 0.65rem 0.75rem; margin: 0; border-radius: 0.5rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-card input:focus, .form-card select:focus, .form-card textarea:focus {
            border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }
        /* Custom styles for radio pills */
        .toggle-pills input[type="radio"] { display: none; }
        .toggle-pills .pill {
            border: 1px solid #e2e8f0; background-color: #f8fafc; color: #475569;
            border-radius: 0.75rem; padding: 0.75rem; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 0.5rem; transition: all 0.2s ease-in-out;
        }
        .toggle-pills .pill:hover { border-color: #93c5fd; background-color: #eff6ff; }
        .toggle-pills input[type="radio"]:checked + .pill {
            border-color: #3b82f6; background-color: #eff6ff;
            color: #2563eb; box-shadow: 0 4px 10px rgba(59, 130, 246, 0.1);
            transform: translateY(-2px);
        }
        .toggle-pills input[type="radio"]:checked + .pill .pill-icon { color: #3b82f6; }
        .pill-icon { font-size: 1.5rem; transition: color 0.2s; }
        .pill-label { font-weight: 600; font-size: 0.875rem; }
    </style>


<div class="container mx-auto px-4 py-8 md:py-12">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 lg:gap-12" style="margin-top: 5rem;">

        <!-- Left Column: Form -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
                <!-- Header -->
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-gray-800 m-0">Book Your Transfer</h2>
                    <p class="text-gray-500 mt-1">Fill in your details to get an instant quote.</p>
                </div>

                <!-- FORM -->
                <form id="msform" class="text-start" method="POST" action="" data-quote-url="{% url 'booking_quote' %}">
                    {% csrf_token %}

                    <!-- Progress Bar -->
                    <div id="progressbar" class="flex items-center mb-8">
                        <div class="step active flex-1 text-center relative">
                            <div class="step-icon mx-auto w-10 h-10 flex items-center justify-center rounded-full bg-blue-600 text-white font-bold text-lg">1</div>
                            <p class="font-semibold text-sm mt-2 text-blue-600">Trip</p>
                        </div>
                        <div class="flex-1 h-px bg-gray-200"></div>
                        <div class="step flex-1 text-center relative">
                            <div class="step-icon mx-auto w-10 h-10 flex items-center justify-center rounded-full bg-gray-200 text-gray-500 font-bold text-lg">2</div>
                            <p class="font-semibold text-sm mt-2 text-gray-500">Details</p>
                        </div>
                        <div class="flex-1 h-px bg-gray-200"></div>
                        <div class="step flex-1 text-center relative">
                            <div class="step-icon mx-auto w-10 h-10 flex items-center justify-center rounded-full bg-gray-200 text-gray-500 font-bold text-lg">3</div>
                            <p class="font-semibold text-sm mt-2 text-gray-500">Contact</p>
                        </div>
                    </div>

                    <!-- ================= STEP 1: TRIP ================= -->
                    <fieldset>
                        <div class="form-card">
                            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Trip Details</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="font-semibold text-gray-600 block mb-2">Trip Type *</label>
                                    <div class="toggle-pills grid grid-cols-2 gap-4">
                                        {% for radio in form.trip_type %}
                                        <label for="{{ radio.id_for_label }}" class="cursor-pointer">
                                            {{ radio.tag }}
                                            <div class="pill">
                                                <i class="fas {% if radio.choice_label == 'One Way' %}fa-arrow-right{% else %}fa-exchange-alt{% endif %} pill-icon"></i>
                                                <span class="pill-label">{{ radio.choice_label }}</span>
                                            </div>
                                        </label>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div>
                                    <label class="font-semibold text-gray-600 block mb-2">Transport Type *</label>
                                    <div class="toggle-pills grid grid-cols-2 gap-4">
                                        {% for radio in form.transport_type %}
                                        <label for="{{ radio.id_for_label }}" class="cursor-pointer">
                                            {{ radio.tag }}
                                            <div class="pill">
                                                <i class="fas {% if radio.choice_label == 'Car' %}fa-car{% else %}fa-bus{% endif %} pill-icon"></i>
                                                <span class="pill-label">{{ radio.choice_label }}</span>
                                            </div>
                                        </label>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6" id="leg1">
                                <div>
                                    <label class="font-semibold text-gray-600 block mb-2">Pickup Location *</label>
                                    {{ form.pickup_location_1 }}
                                </div>
                                <div>
                                    <label class="font-semibold text-gray-600 block mb-2">Dropoff Location *</label>
                                    {{ form.dropoff_location_1 }}
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6" id="leg2" style="display:none;">
                                <div>
                                    <label class="font-semibold text-gray-600 block mb-2">Return Pickup Location *</label>
                                    {{ form.pickup_location_2 }}
                                </div>
                                <div>
                                    <label class="font-semibold text-gray-600 block mb-2">Return Dropoff Location *</label>
                                    {{ form.dropoff_location_2 }}
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                                <div>
                                    <label class="font-semibold text-gray-600 block mb-2">Pickup Time *</label>
                                    {{ form.pickup_time }}
                                </div>
                                <div id="return_time_container" style="display:none;">
                                    <label class="font-semibold text-gray-600 block mb-2">Return Time *</label>
                                    {{ form.return_time }}
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-end items-center mt-8">
                            <button type="button" name="next" class="next bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-transform hover:scale-105">Next Step</button>
                        </div>
                    </fieldset>

                    <!-- ================= STEP 2: ADDRESSES & DATES ================= -->
                    <fieldset style="display: none;">
                        <div class="form-card">
                            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Addresses & Dates</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="font-semibold text-gray-600 block mb-2">Pickup Address (optional)</label>
                                    {{ form.pickup_address_1 }}
                                </div>
                                 <div>
                                    <label class="font-semibold text-gray-600 block mb-2">Dropoff Address (optional)</label>
                                    {{ form.dropoff_address_1 }}
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6" id="leg2_address" style="display:none;">
                                <div>
                                    <label class="font-semibold text-gray-600 block mb-2">Return Pickup Address (optional)</label>
                                    {{ form.pickup_address_2 }}
                                </div>
                                 <div>
                                    <label class="font-semibold text-gray-600 block mb-2">Return Dropoff Address (optional)</label>
                                    {{ form.dropoff_address_2 }}
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                                <div>
                                    <label class="font-semibold text-gray-600 block mb-2">Check-in Date</label>
                                    {{ form.checkin_date }}
                                </div>
                                <div id="checkout_date_container" style="display:none;">
                                    <label class="font-semibold text-gray-600 block mb-2">Checkout Date</label>
                                    {{ form.checkout_date }}
                                </div>
                                 <div>
                                    <label class="font-semibold text-gray-600 block mb-2">Flight Number</label>
                                    {{ form.flight_number }}
                                </div>
                            </div>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                                <div>
                                    <label class="font-semibold text-gray-600 block mb-2">Booster Seats</label>
                                    {{ form.booster_seats }}
                                </div>
                                 <div>
                                    <label class="font-semibold text-gray-600 block mb-2">Promo Code</label>
                                    {{ form.promo_code }}
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mt-8">
                            <button type="button" name="previous" class="previous bg-gray-200 text-gray-700 font-bold py-3 px-8 rounded-lg hover:bg-gray-300 transition-colors">Previous</button>
                            <button type="button" name="next" class="next bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-transform hover:scale-105">Next Step</button>
                        </div>
                    </fieldset>

                    <!-- ================= STEP 3: PASSENGERS & CONTACT ================= -->
                    <fieldset style="display: none;">
                        <div class="form-card">
                            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Passengers & Contact</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <label class="font-semibold text-gray-600 block mb-2">Adults *</label>
                                    {{ form.adults }}
                                </div>
                                <div>
                                    <label class="font-semibold text-gray-600 block mb-2">Children</label>
                                    {{ form.children }}
                                </div>
                                <div>
                                    <label class="font-semibold text-gray-600 block mb-2">Luggage</label>
                                    {{ form.luggage }}
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                                <div>
                                    <label class="font-semibold text-gray-600 block mb-2">First Name *</label>
                                    {{ form.first_name }}
                                </div>
                                <div>
                                    <label class="font-semibold text-gray-600 block mb-2">Last Name *</label>
                                    {{ form.last_name }}
                                </div>
                                 <div>
                                    <label class="font-semibold text-gray-600 block mb-2">Email *</label>
                                    {{ form.email }}
                                </div>
                                <div>
                                    <label class="font-semibold text-gray-600 block mb-2">Phone *</label>
                                    <div class="flex gap-2">
                                        <div class="w-1/3">{{ form.country_code }}</div>
                                        <div class="w-2/3">{{ form.phone }}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-6">
                                <label class="font-semibold text-gray-600 block mb-2">Notes</label>
                                {{ form.notes }}
                            </div>
                        </div>
                        <div class="flex justify-between items-center mt-8">
                            <button type="button" name="previous" class="previous bg-gray-200 text-gray-700 font-bold py-3 px-8 rounded-lg hover:bg-gray-300 transition-colors">Previous</button>
                            <button type="submit" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 transition-transform hover:scale-105">Confirm Booking</button>
                        </div>
                    </fieldset>
                </form>
            </div>
        </div>

        <!-- Right Column: Booking Summary -->
        <div class="lg:col-span-1">
            <div class="sticky top-10">
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 border-b pb-3 mb-4">Booking Summary</h3>

                    <div class="space-y-4 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-500">From:</span>
                            <span id="summary-pickup" class="font-semibold text-gray-800 text-right">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">To:</span>
                            <span id="summary-dropoff" class="font-semibold text-gray-800 text-right">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Date & Time:</span>
                            <span id="summary-datetime" class="font-semibold text-gray-800 text-right">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Passengers:</span>
                            <span id="summary-passengers" class="font-semibold text-gray-800">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Trip Type:</span>
                            <span id="summary-trip-type" class="font-semibold text-gray-800">-</span>
                        </div>
                    </div>

                    <div class="border-t mt-4 pt-4">
                        <div class="text-sm text-gray-500 mb-1" id="quoteHint">Complete trip details for a price</div>
                        <div class="flex justify-between items-center">
                            <span class="text-lg font-bold text-gray-800">Estimated Total</span>
                            <span id="priceDisplay" class="text-2xl font-bold text-blue-600">€0.00</span>
                        </div>
                    </div>
                </div>
                <div class="text-center text-xs text-gray-400 mt-4">
                    Questions? <a href="#" class="text-blue-600 hover:underline">Contact us</a>.
                </div>
            </div>
        </div>

    </div>
</div>

<!-- ===================== JS: Wizard & Live Summary ===================== -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('msform');
    // Wizard elements
    const sets = Array.from(form.querySelectorAll("fieldset"));
    const steps = Array.from(document.querySelectorAll("#progressbar .step"));

    // Summary elements
    const summary = {
        pickup: document.getElementById('summary-pickup'),
        dropoff: document.getElementById('summary-dropoff'),
        datetime: document.getElementById('summary-datetime'),
        passengers: document.getElementById('summary-passengers'),
        tripType: document.getElementById('summary-trip-type'),
        price: document.getElementById('priceDisplay'),
        hint: document.getElementById('quoteHint')
    };

    // Form logic elements
    const quoteUrl = form.dataset.quoteUrl;
    const leg2 = document.getElementById("leg2"), leg2_address = document.getElementById("leg2_address");
    const rt = document.getElementById("return_time_container"), co = document.getElementById("checkout_date_container");

    let currentStep = 0;

    function updateWizardUI(idx) {
        steps.forEach((step, k) => {
            const icon = step.querySelector('.step-icon');
            const text = step.querySelector('p');
            if (k < idx) { // Completed step
                icon.classList.remove('bg-gray-200', 'text-gray-500', 'bg-blue-600');
                icon.classList.add('bg-green-500', 'text-white');
                icon.innerHTML = '<i class="fas fa-check"></i>';
                text.classList.remove('text-gray-500', 'text-blue-600');
                text.classList.add('text-green-600');
            } else if (k === idx) { // Active step
                icon.classList.remove('bg-gray-200', 'text-gray-500', 'bg-green-500');
                icon.classList.add('bg-blue-600', 'text-white');
                icon.innerHTML = k + 1;
                text.classList.remove('text-gray-500', 'text-green-600');
                text.classList.add('text-blue-600');
            } else { // Future step
                icon.classList.remove('bg-blue-600', 'text-white', 'bg-green-500');
                icon.classList.add('bg-gray-200', 'text-gray-500');
                icon.innerHTML = k + 1;
                text.classList.remove('text-blue-600', 'text-green-600');
                text.classList.add('text-gray-500');
            }
        });
        sets.forEach((fs, k) => fs.style.display = (k === idx ? "block" : "none"));
    }

    form.addEventListener("click", (e) => {
        if (e.target.closest(".next")) {
            currentStep = Math.min(currentStep + 1, sets.length - 1);
            updateWizardUI(currentStep);
        }
        if (e.target.closest(".previous")) {
            currentStep = Math.max(currentStep - 1, 0);
            updateWizardUI(currentStep);
        }
    });

    // --- Dynamic Form & Pricing Logic ---
    const get = sel => (form.querySelector(sel) || {}).value || "";
    const currentTrip = () => (form.querySelector('input[name="trip_type"]:checked') || {}).value || "";

    function toggleRT(){
        const isRT = currentTrip() === "Round Trip";
        const d = isRT ? "" : "none";
        if(leg2) leg2.style.display = d;
        if(leg2_address) leg2_address.style.display = d;
        if(rt) rt.style.display = d;
        if(co) co.style.display = d;
    }

    function updateSummary() {
        // Safely update text fields, checking if elements exist first
        const pickupEl = form.querySelector('[name="pickup_location_1"]');
        if (summary.pickup && pickupEl) {
            summary.pickup.textContent = (pickupEl.selectedIndex > -1) ? pickupEl.options[pickupEl.selectedIndex].text : '-';
        }

        const dropoffEl = form.querySelector('[name="dropoff_location_1"]');
        if (summary.dropoff && dropoffEl) {
            summary.dropoff.textContent = (dropoffEl.selectedIndex > -1) ? dropoffEl.options[dropoffEl.selectedIndex].text : '-';
        }

        const pickupTimeEl = form.querySelector('[name="pickup_time"]');
        if (summary.datetime && pickupTimeEl) {
            summary.datetime.textContent = (pickupTimeEl.selectedIndex > -1 && pickupTimeEl.value) ? pickupTimeEl.options[pickupTimeEl.selectedIndex].text : '-';
        }

        const adults = parseInt(get('[name="adults"]') || 0);
        const children = parseInt(get('[name="children"]') || 0);
        if (summary.passengers) {
            const totalPassengers = adults + children;
            summary.passengers.textContent = totalPassengers > 0 ? `${totalPassengers} passenger(s)` : '-';
        }

        if (summary.tripType) {
            summary.tripType.textContent = currentTrip() || '-';
        }
    }

    function buildQuery(){
        const p = new URLSearchParams();
        const put = (k,v)=>{ if(v) p.set(k,v); };
        const adults = parseInt(get('[name="adults"]') || 1);
        const children = parseInt(get('[name="children"]') || 0);
        put("passengers", adults + children); // Use combined passengers for quote
        put("trip_type", currentTrip());
        const transport = form.querySelector('input[name="transport_type"]:checked');
        if (transport) put("transport_type", transport.value);

        ["pickup_location_1","dropoff_location_1","pickup_location_2","dropoff_location_2", "pickup_time","return_time","promo_code"].forEach(n=>{
          const el = form.querySelector(`[name="${n}"]`);
          if(el) put(n, el.value);
        });
        return p.toString();
    }

    function showPrice(val){ if(summary.price) summary.price.textContent = val; }
    function showMessage(msg){ if(summary.hint){ summary.hint.textContent = msg; summary.hint.style.display = ''; } }
    function clearMessage(){ if(summary.hint){ summary.hint.style.display = 'none'; } }

    let t; const debounce=(fn,ms=300)=>(...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); };

    async function fetchQuote(){
        updateSummary();
        const p1 = get('[name="pickup_location_1"]'), d1 = get('[name="dropoff_location_1"]');
        if(!p1 || !d1){ showPrice("€0.00"); showMessage("Complete trip details for a price"); return; }
        try{
            const res = await fetch(`${quoteUrl}?${buildQuery()}`);
            const data = await res.json();
            if (data && data.price != null) { clearMessage(); showPrice(`€${Number(data.price).toFixed(2)}`); }
            else { showPrice("€0.00"); showMessage("No price found for this route"); }
        }catch(_){ showPrice("€0.00"); showMessage("Could not fetch estimate"); }
    }

    const debouncedFetchQuote = debounce(fetchQuote);
    form.addEventListener("change", (e) => {
        if (e.target.name === "trip_type") toggleRT();
        debouncedFetchQuote();
    });
    form.addEventListener("keyup", debouncedFetchQuote);

    // Initial setup
    updateWizardUI(0);
    toggleRT();
    updateSummary();
});
</script>

<!-- ===================== Google Places API ===================== -->
<script>
  function initPlaces(){
    const ids = ['id_pickup_address_1', 'id_dropoff_address_1', 'id_pickup_address_2', 'id_dropoff_address_2'];
    ids.forEach(id => {
      const el = document.getElementById(id);
      if(el && window.google && window.google.maps && window.google.maps.places){
        new google.maps.places.Autocomplete(el, { types:['address'] });
      }
    });
  }
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&libraries=places&callback=initPlaces"></script>

{% endblock %}
