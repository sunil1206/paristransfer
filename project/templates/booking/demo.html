{% extends "core/base.html" %}
{% load static %}
{% block content %}
<head>
 <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>

        /* Style the input fields generated by Django forms */
        .form-card input[type="text"],
        .form-card input[type="number"],
        .form-card input[type="time"],
        .form-card input[type="date"],
        .form-card input[type="email"],
        .form-card select,
        .form-card textarea {
            border: 1px solid #e5e7eb;
            outline: none;
            width: 100%;
            background-color: #f9fafb;
            font-size: 1rem;
            padding: 0.5rem 0.75rem;
            margin: 0;
            border-radius: 0.5rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-card input:focus,
        .form-card select:focus,
        .form-card textarea:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        /* Custom styles for radio pills */
        .toggle-pills input[type="radio"] {
            display: none;
        }
        .toggle-pills .pill {
            border: 1px solid #d1d5db;
            background-color: #f9fafb;
            color: #374151;
            border-radius: 9999px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.15s;
        }
        .toggle-pills .pill:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .toggle-pills input[type="radio"]:checked + span {
            color: #2563eb;
            font-weight: 600;
        }
        .toggle-pills input[type="radio"]:checked + span,
        .toggle-pills .pill input:checked ~ span {
             color:#2563eb; font-weight:600
        }
    </style>
</head>

<div class="flex items-center justify-center min-h-screen p-4" style="margin-top: 6rem;">
    <div class="w-full max-w-4xl mx-auto">
        <div class="bg-white rounded-xl shadow-lg p-4 md:p-8">
            <!-- Header -->
            <div class="flex flex-col md:flex-row items-center justify-between gap-2 mb-4">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800 m-0">Book Your Transfer</h2>
                    <p class="text-gray-500 m-0">Fill all fields to move to the next step</p>
                </div>
            </div>

            <!-- FORM -->
            <form id="msform" class="text-start" method="POST" action="" data-quote-url="{% url 'booking_quote' %}">
                {% csrf_token %}

                <!-- Progress Bar -->
                <ul id="progressbar" class="flex justify-between mb-4 p-0">
                    <li class="active text-center w-1/3 relative font-semibold text-sm">
                        <i class="fa fa-road mx-auto mb-2 flex items-center justify-center w-10 h-10 rounded-full bg-blue-500 text-white"></i> Trip
                    </li>
                    <li class="text-center w-1/3 relative font-semibold text-sm text-gray-400">
                        <i class="fa fa-map-marker-alt mx-auto mb-2 flex items-center justify-center w-10 h-10 rounded-full bg-gray-200"></i> Addresses & Dates
                    </li>
                    <li class="text-center w-1/3 relative font-semibold text-sm text-gray-400">
                        <i class="fa fa-user-friends mx-auto mb-2 flex items-center justify-center w-10 h-10 rounded-full bg-gray-200"></i> Passengers & Contact
                    </li>
                </ul>
                <div class="progress h-2 bg-gray-200 rounded-full mb-6">
                    <div class="progress-bar bg-blue-500 h-2 rounded-full transition-all duration-300"></div>
                </div>

                <!-- ================= STEP 1: TRIP ================= -->
                <fieldset>
                    <div class="form-card">
                        <div class="flex justify-between mb-4">
                            <h3 class="text-xl font-bold text-gray-800 m-0">Trip Details</h3>
                            <span class="font-semibold text-gray-500">Step 1 / 3</span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="font-semibold text-gray-600 block mb-1">Trip Type *</label>
                                <div class="toggle-pills flex flex-wrap gap-2">
                                    {% for radio in form.trip_type %}
                                    <label class="pill">{{ radio.tag }} <span>{{ radio.choice_label }}</span></label>
                                    {% endfor %}
                                </div>
                            </div>
                            <div>
                                <label class="font-semibold text-gray-600 block mb-1">Transport Type *</label>
                                <div class="toggle-pills flex flex-wrap gap-2">
                                    {% for radio in form.transport_type %}
                                    <label class="pill">{{ radio.tag }} <span>{{ radio.choice_label }}</span></label>
                                    {% endfor %}
                                </div>
                            </div>
                            <div>
                                <label class="font-semibold text-gray-600 block mb-1">Passengers *</label>
                                {{ form.passengers }}
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4" id="leg1">
                            <div>
                                <label class="font-semibold text-gray-600 block mb-1">Pickup Location *</label>
                                {{ form.pickup_location_1 }}
                            </div>
                            <div>
                                <label class="font-semibold text-gray-600 block mb-1">Dropoff Location *</label>
                                {{ form.dropoff_location_1 }}
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4" id="leg2" style="display:none;">
                            <div>
                                <label class="font-semibold text-gray-600 block mb-1">Return Pickup Location *</label>
                                {{ form.pickup_location_2 }}
                            </div>
                            <div>
                                <label class="font-semibold text-gray-600 block mb-1">Return Dropoff Location *</label>
                                {{ form.dropoff_location_2 }}
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <div>
                                <label class="font-semibold text-gray-600 block mb-1">Pickup Time *</label>
                                {{ form.pickup_time }}
                            </div>
                            <div id="return_time_container" style="display:none;">
                                <label class="font-semibold text-gray-600 block mb-1">Return Time *</label>
                                {{ form.return_time }}
                            </div>
                        </div>
                        <div class="text-sm text-gray-500 mt-2" id="quoteHint">Select pickup & drop-off to get an estimate.</div>
                    </div>
                    <div class="flex justify-end items-center gap-4 mt-6">
                        <div class="bg-blue-50 border border-dashed border-blue-200 text-blue-600 px-4 py-2 rounded-lg">
                            <span class="text-xs uppercase font-semibold">Estimated</span>
                            <span class="font-bold ml-2" id="priceDisplay">€00.00</span>
                        </div>
                        <button type="button" name="next" class="next bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">Next</button>
                    </div>
                </fieldset>

                <!-- ================= STEP 2: ADDRESSES & DATES ================= -->
                <fieldset style="display: none;">
                    <div class="form-card">
                         <div class="flex justify-between mb-4">
                            <h3 class="text-xl font-bold text-gray-800 m-0">Addresses & Dates</h3>
                            <span class="font-semibold text-gray-500">Step 2 / 3</span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="font-semibold text-gray-600 block mb-1">Pickup Address (optional)</label>
                                {{ form.pickup_address }}
                            </div>
                             <div>
                                <label class="font-semibold text-gray-600 block mb-1">Dropoff Address (optional)</label>
                                {{ form.dropoff_address }}
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                            <div>
                                <label class="font-semibold text-gray-600 block mb-1">Check-in Date</label>
                                {{ form.checkin_date }}
                            </div>
                            <div id="checkout_date_container" style="display:none;">
                                <label class="font-semibold text-gray-600 block mb-1">Checkout Date</label>
                                {{ form.checkout_date }}
                            </div>
                             <div>
                                <label class="font-semibold text-gray-600 block mb-1">Flight Number</label>
                                {{ form.flight_number }}
                            </div>
                        </div>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <div>
                                <label class="font-semibold text-gray-600 block mb-1">Booster Seats</label>
                                {{ form.booster_seats }}
                            </div>
                             <div>
                                <label class="font-semibold text-gray-600 block mb-1">Promo Code</label>
                                {{ form.promo_code }}
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end items-center gap-4 mt-6">
                        <button type="button" name="previous" class="previous bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 transition-colors">Previous</button>
                        <button type="button" name="next" class="next bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">Next</button>
                    </div>
                </fieldset>

                <!-- ================= STEP 3: PASSENGERS & CONTACT ================= -->
                <fieldset style="display: none;">
                    <div class="form-card">
                        <div class="flex justify-between mb-4">
                            <h3 class="text-xl font-bold text-gray-800 m-0">Passengers & Contact</h3>
                            <span class="font-semibold text-gray-500">Step 3 / 3</span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="font-semibold text-gray-600 block mb-1">Adults *</label>
                                {{ form.adults }}
                            </div>
                            <div>
                                <label class="font-semibold text-gray-600 block mb-1">Children</label>
                                {{ form.children }}
                            </div>
                            <div>
                                <label class="font-semibold text-gray-600 block mb-1">Luggage</label>
                                {{ form.luggage }}
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <div>
                                <label class="font-semibold text-gray-600 block mb-1">First Name *</label>
                                {{ form.first_name }}
                            </div>
                            <div>
                                <label class="font-semibold text-gray-600 block mb-1">Last Name *</label>
                                {{ form.last_name }}
                            </div>
                             <div>
                                <label class="font-semibold text-gray-600 block mb-1">Email *</label>
                                {{ form.email }}
                            </div>
                            <div>
                                <label class="font-semibold text-gray-600 block mb-1">Phone *</label>
                                <div class="flex gap-2">
                                    <div class="w-1/3">{{ form.country_code }}</div>
                                    <div class="w-2/3">{{ form.phone }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="font-semibold text-gray-600 block mb-1">Notes</label>
                            {{ form.notes }}
                        </div>
                    </div>
                    <div class="flex justify-between items-center gap-4 mt-6">
                         <div class="bg-blue-50 border border-dashed border-blue-200 text-blue-600 px-4 py-2 rounded-lg">
                            <span class="text-xs uppercase font-semibold">Final Price</span>
                            <span class="font-bold ml-2" id="priceDisplayStep3">€0.00</span>
                        </div>
                        <div class="flex items-center gap-4">
                            <button type="button" name="previous" class="previous bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 transition-colors">Previous</button>
                            <button type="submit" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition-colors">Submit</button>
                        </div>
                    </div>
                </fieldset>
            </form>
        </div>
    </div>
</div>

<!-- ===================== JS: Wizard ===================== -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const sets = Array.from(document.querySelectorAll("#msform fieldset"));
    const bar = document.querySelector(".progress-bar");
    const steps = Array.from(document.querySelectorAll("#progressbar li"));
    const icons = Array.from(document.querySelectorAll("#progressbar i"));
    let i = 0;

    function show(idx) {
        sets.forEach((fs, k) => fs.style.display = (k === idx ? "block" : "none"));
        steps.forEach((li, k) => {
            li.classList.toggle("text-blue-500", k <= idx);
            li.classList.toggle("text-gray-400", k > idx);
        });
        icons.forEach((icon, k) => {
             icon.classList.toggle("bg-blue-500", k <= idx);
             icon.classList.toggle("text-white", k <= idx);
             icon.classList.toggle("bg-gray-200", k > idx);
        });
        if (bar) {
            bar.style.width = (i / (sets.length - 1)) * 100 + "%";
        }
    }

    document.addEventListener("click", (e) => {
        if (e.target.classList.contains("next")) {
            i = Math.min(i + 1, sets.length - 1);
            show(i);
        }
        if (e.target.classList.contains("previous")) {
            i = Math.max(i - 1, 0);
            show(i);
        }
    });
    show(0);
});
</script>

<!-- ===================== JS: Round Trip UI & Live Price ===================== -->
<script>
(function(){
  const form = document.getElementById('msform');
  const priceEls = [document.getElementById('priceDisplay'), document.getElementById('priceDisplayStep3')].filter(Boolean);
  const quoteUrl = form.dataset.quoteUrl;
  const hint = document.getElementById('quoteHint');

  // Round trip UI elements
  const leg2 = document.getElementById("leg2");
  const rt   = document.getElementById("return_time_container");
  const co   = document.getElementById("checkout_date_container");

  const get = sel => (form.querySelector(sel) || {}).value || "";
  const currentTrip = () => (form.querySelector('input[name="trip_type"]:checked') || {}).value || "";
  const setReq = (name,on) => {
    const el=form.querySelector(`[name="${name}"]`); if(!el) return;
    on ? el.setAttribute('required','required') : el.removeAttribute('required');
  };

  function toggleRT(){
    const isRT = currentTrip() === "Round Trip";
    const displayStyle = isRT ? "" : "none";
    if (leg2) leg2.style.display = displayStyle;
    if (rt) rt.style.display = displayStyle;
    if (co) co.style.display = displayStyle;
    setReq("pickup_location_2", isRT);
    setReq("dropoff_location_2", isRT);
    setReq("return_time", isRT);

    const p1 = get('[name="pickup_location_1"]'), d1 = get('[name="dropoff_location_1"]');
    const p2 = form.querySelector('[name="pickup_location_2"]'), d2 = form.querySelector('[name="dropoff_location_2"]');
    if(isRT && p1 && d1 && p2 && d2 && !p2.value && !d2.value){
      p2.value = d1; d2.value = p1;
      p2.dispatchEvent(new Event("change", { bubbles: true }));
      d2.dispatchEvent(new Event("change", { bubbles: true }));
    }
  }

  function ensureDefaults() {
    if (!form.querySelector('input[name="trip_type"]:checked')) form.querySelector('input[name="trip_type"]')?.click();
    if (!form.querySelector('input[name="transport_type"]:checked')) form.querySelector('input[name="transport_type"]')?.click();
  }

  const getTransport = () => (form.querySelector('input[name="transport_type"]:checked') || {}).value || "";

  function buildQuery(){
    const p = new URLSearchParams();
    const put = (k,v)=>{ if(v) p.set(k,v); };
    put("trip_type", currentTrip());
    put("transport_type", getTransport());
    ["pickup_location_1","dropoff_location_1","pickup_location_2","dropoff_location_2",
     "pickup_time","return_time","passengers","promo_code"].forEach(n=>{
      const el = form.querySelector(`[name="${n}"]`);
      if(el) put(n, el.value);
    });
    return p.toString();
  }

  function showPrice(val){ priceEls.forEach(el=> el.textContent = val); }
  function showMessage(msg){ if(hint){ hint.textContent = msg; hint.style.display = ''; } }
  function clearMessage(){ if(hint){ hint.style.display = 'none'; } }

  let t; const debounce=(fn,ms=250)=>(...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); };

  async function fetchQuote(){
    ensureDefaults();
    const p1 = form.querySelector('[name="pickup_location_1"]')?.value;
    const d1 = form.querySelector('[name="dropoff_location_1"]')?.value;
    if(!p1 || !d1){
      showPrice("€0.00");
      showMessage("Select pickup & drop-off to get an estimate.");
      return;
    }
    try{
      const res = await fetch(`${quoteUrl}?${buildQuery()}`);
      const data = await res.json();
      if (data && data.price != null) {
        clearMessage();
        showPrice(`€${Number(data.price).toFixed(2)}`);
      } else {
        showPrice("€0.00");
        showMessage("No price found for this route.");
      }
    }catch(_){
      showPrice("€0.00");
      showMessage("Could not fetch an estimate.");
    }
  }

  const debouncedFetchQuote = debounce(fetchQuote);

  form.addEventListener("change", (e) => {
    if (e.target.name === "trip_type") toggleRT();
    debouncedFetchQuote();
  });
  form.addEventListener("keyup", debouncedFetchQuote);

  ensureDefaults();
  toggleRT();
  debouncedFetchQuote();
})();
</script>

{% endblock %}
